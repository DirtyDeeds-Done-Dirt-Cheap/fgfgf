<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <!-- Важно для мобильной адаптации -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Мои напоминания</title>
  <style>
    /* БАЗОВЫЕ СТИЛИ, которые затем могут быть переопределены inline-стилями из JS */
    body {
      font-family: sans-serif;
      margin: 20px;
      padding-bottom: 80px; /* отступ снизу, чтобы кнопка не накладывалась на контент */
      transition: background-color 0.3s, color 0.3s;
      background-color: #fff;  /* может быть переопределен */
      color: #000;             /* может быть переопределен */
    }
    h1 {
      margin-bottom: 20px;
    }
    button, select, input {
      font-size: 14px;
      padding: 6px 10px;
    }

    /* Контейнер "в ряд" для формы ввода */
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      background-color: transparent; /* будет переопределяться */
      color: inherit;               /* будет переопределяться */
      padding: 0;                   /* при желании можно задать отступы */
    }

    /* Контейнер для панелей категорий */
    #categoriesContainer {
      margin-top: 20px;
    }

    /* Панель категории */
    .category-panel {
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden; /* чтобы учесть границы при сворачивании/разворачивании */
    }
    .category-header {
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5; /* переопределится */
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .category-header h2 {
      margin: 0;
      font-size: 16px;
    }
    .category-content {
      display: none; /* свернуто по умолчанию */
      padding: 10px;
    }

    /* Карточка одного напоминания */
    .reminder-item {
      background-color: #fafafa; /* переопределится */
      margin: 8px 0;
      padding: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .delete {
      background-color: #ff5555;
      border: none;
      color: #fff;
      cursor: pointer;
    }

    /* КНОПКА "ТЕМА" ВНИЗУ СПРАВА */
    #themeToggle {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 9999;
      background-color: #888; /* можно переопределять, если хотите */
      color: #fff;
      border: none;
      border-radius: 4px;
    }

    /* ПАНЕЛЬ НАСТРОЙКИ ТЕМЫ (скрывается/показывается при нажатии) */
    #themePanel {
      position: fixed;
      bottom: 70px; /* чуть выше кнопки "Тема" */
      right: 20px;
      z-index: 9999;
      background: #eee;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      width: 220px;
      display: none; /* по умолчанию спрятано */
    }
    #themePanel label {
      display: block;
      margin-top: 10px;
    }

    /* АДАПТИВНОСТЬ ДЛЯ МОБИЛЬНЫХ */
    @media (max-width: 600px) {
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      .row > * {
        flex: 1 1 auto;
      }
      #themeToggle {
        right: 10px;
        bottom: 10px;
      }
      #themePanel {
        right: 10px;
        width: 90%; /* почти на всю ширину экрана */
      }
    }
  </style>
</head>
<body>

  <h1 id="title">Мои напоминания</h1>

  <!-- Форма ввода напоминания (в ряд, но на узком экране - в столбик) -->
  <div class="row">
    <input type="text" id="reminderText" placeholder="Текст напоминания" />
    <input type="date" id="reminderDate" />
    <input type="time" id="reminderTime" />

    <!-- Категории (фиксированный список) -->
    <select id="reminderCategory">
      <option value="Работа">Работа</option>
      <option value="Личное">Личное</option>
      <option value="Учёба">Учёба</option>
    </select>

    <!-- Повтор -->
    <select id="reminderRepeat">
      <option value="none">Без повтора</option>
      <option value="10m">Каждые 10 минут</option>
      <option value="1h">Каждый час</option>
      <option value="1d">Каждый день</option>
      <option value="1w">Раз в неделю</option>
      <option value="1M">Каждый месяц</option>
    </select>

    <button id="addReminder">Добавить</button>

    <!-- Выбор языка -->
    <select id="languageSelect">
      <option value="ru">Рус</option>
      <option value="en">Eng</option>
      <option value="uk">Укр</option>
    </select>
  </div>

  <!-- Контейнер для панелей (каждая категория сворачивается/разворачивается) -->
  <div id="categoriesContainer"></div>

  <!-- КНОПКА настройки темы -->
  <button id="themeToggle">Тема</button>

  <!-- ПАНЕЛЬКА НАСТРОЙКИ ЦВЕТОВ (открывается при нажатии на "Тема") -->
  <div id="themePanel">
    <h3>Настройка темы</h3>

    <label>
      Цвет фона страницы:
      <input type="color" id="bodyBgColor" value="#ffffff">
    </label>

    <label>
      Цвет текста страницы:
      <input type="color" id="bodyTextColor" value="#000000">
    </label>

    <label>
      Цвет фона формы:
      <input type="color" id="formBgColor" value="#ffffff">
    </label>

    <label>
      Цвет текста формы:
      <input type="color" id="formTextColor" value="#000000">
    </label>

    <label>
      Цвет фона панели категории:
      <input type="color" id="panelBgColor" value="#f5f5f5">
    </label>

    <label>
      Цвет фона напоминания:
      <input type="color" id="itemBgColor" value="#fafafa">
    </label>

    <label>
      Цвет текста в панелях/напоминаниях:
      <input type="color" id="panelTextColor" value="#000000">
    </label>

    <button id="saveCustomTheme">Применить</button>
  </div>

  <script>
    // =========================================================
    //      1) МАССИВ НАПОМИНАНИЙ И ДРУГИЕ ПЕРЕМЕННЫЕ
    // =========================================================
    let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
    let reminderTimeouts = []; // список setTimeout

    // Языковый словарь
    const translations = {
      ru: {
        title:             "Мои напоминания",
        placeholderText:   "Текст напоминания",
        addBtn:            "Добавить",
        repeatNone:        "Без повтора",
        every10m:          "Каждые 10 минут",
        every1h:           "Каждый час",
        every1d:           "Каждый день",
        every1w:           "Раз в неделю",
        every1M:           "Каждый месяц",
        themeBtn:          "Тема",
        work:              "Работа",
        personal:          "Личное",
        study:             "Учёба",
        deleteBtn:         "Удалить"
      },
      en: {
        title:             "My Reminders",
        placeholderText:   "Reminder text",
        addBtn:            "Add",
        repeatNone:        "No repeat",
        every10m:          "Every 10 minutes",
        every1h:           "Every hour",
        every1d:           "Every day",
        every1w:           "Once a week",
        every1M:           "Every month",
        themeBtn:          "Theme",
        work:              "Work",
        personal:          "Personal",
        study:             "Study",
        deleteBtn:         "Delete"
      },
      uk: {
        title:             "Мої нагадування",
        placeholderText:   "Текст нагадування",
        addBtn:            "Додати",
        repeatNone:        "Без повтору",
        every10m:          "Кожні 10 хвилин",
        every1h:           "Щогодини",
        every1d:           "Щодня",
        every1w:           "Раз на тиждень",
        every1M:           "Щомісяця",
        themeBtn:          "Тема",
        work:              "Робота",
        personal:          "Особисте",
        study:             "Навчання",
        deleteBtn:         "Видалити"
      }
    };

    let currentLang = localStorage.getItem('language') || 'ru';

    // =========================================================
    //     2) ЧТЕНИЕ/ПРИМЕНЕНИЕ ПОЛЬЗОВАТЕЛЬСКИХ ЦВЕТОВ
    // =========================================================
    // В localStorage храним объект вида:
    // {
    //   bodyBg: "#ffffff",
    //   bodyText: "#000000",
    //   formBg: "#ffffff",
    //   formText: "#000000",
    //   panelBg: "#f5f5f5",
    //   panelText: "#000000",
    //   itemBg: "#fafafa"
    // }
    function loadCustomColors() {
      let savedColors = localStorage.getItem('customColors');
      if (!savedColors) {
        // Если нет сохраненных — вернем дефолты
        return {
          bodyBg:   "#ffffff",
          bodyText: "#000000",
          formBg:   "#ffffff",
          formText: "#000000",
          panelBg:  "#f5f5f5",
          panelText:"#000000",
          itemBg:   "#fafafa"
        };
      }
      return JSON.parse(savedColors);
    }

    let customColors = loadCustomColors();

    function saveCustomColors() {
      localStorage.setItem('customColors', JSON.stringify(customColors));
    }

    // Непосредственно применяем цвета к элементам
    function applyCustomColors() {
      // body
      document.body.style.backgroundColor = customColors.bodyBg;
      document.body.style.color = customColors.bodyText;

      // Форма (div.row)
      const rowEl = document.querySelector('.row');
      if (rowEl) {
        rowEl.style.backgroundColor = customColors.formBg;
        rowEl.style.color = customColors.formText;
      }

      // Заголовки панелей категорий
      document.querySelectorAll('.category-header').forEach(header => {
        header.style.backgroundColor = customColors.panelBg;
        header.style.color = customColors.panelText;
      });

      // Контент напоминаний
      document.querySelectorAll('.reminder-item').forEach(item => {
        item.style.backgroundColor = customColors.itemBg;
        item.style.color = customColors.panelText; // текст тот же что в панелях
      });
    }

    // =========================================================
    //          3) ИНТЕРФЕЙС ДЛЯ НАСТРОЙКИ ТЕМЫ
    // =========================================================
    const themeToggleBtn = document.getElementById('themeToggle');
    const themePanel     = document.getElementById('themePanel');

    // Элементы color-input:
    const bodyBgColor   = document.getElementById('bodyBgColor');
    const bodyTextColor = document.getElementById('bodyTextColor');
    const formBgColor   = document.getElementById('formBgColor');
    const formTextColor = document.getElementById('formTextColor');
    const panelBgColor  = document.getElementById('panelBgColor');
    const panelTextColor= document.getElementById('panelTextColor');
    const itemBgColor   = document.getElementById('itemBgColor');

    // Заполним поля текущими значениями
    function initColorPickers() {
      bodyBgColor.value    = customColors.bodyBg;
      bodyTextColor.value  = customColors.bodyText;
      formBgColor.value    = customColors.formBg;
      formTextColor.value  = customColors.formText;
      panelBgColor.value   = customColors.panelBg;
      panelTextColor.value = customColors.panelText;
      itemBgColor.value    = customColors.itemBg;
    }

    // Кнопка "Тема" - показать/скрыть панель
    let themePanelOpen = false;
    themeToggleBtn.addEventListener('click', () => {
      themePanelOpen = !themePanelOpen;
      themePanel.style.display = themePanelOpen ? 'block' : 'none';
    });

    // Кнопка "Применить" в панели
    document.getElementById('saveCustomTheme').addEventListener('click', () => {
      // Считываем из color-пикеров
      customColors.bodyBg    = bodyBgColor.value;
      customColors.bodyText  = bodyTextColor.value;
      customColors.formBg    = formBgColor.value;
      customColors.formText  = formTextColor.value;
      customColors.panelBg   = panelBgColor.value;
      customColors.panelText = panelTextColor.value;
      customColors.itemBg    = itemBgColor.value;

      // Сохраняем и применяем
      saveCustomColors();
      applyCustomColors();
    });

    // =========================================================
    //         4) ПЕРЕКЛЮЧЕНИЕ ЯЗЫКА
    // =========================================================
    const languageSelect = document.getElementById('languageSelect');
    languageSelect.value = currentLang; 
    languageSelect.addEventListener('change', (e) => {
      currentLang = e.target.value;
      localStorage.setItem('language', currentLang);
      applyTranslations();
      renderCategories();
    });

    function applyTranslations() {
      const t = translations[currentLang];
      if (!t) return;

      document.getElementById('title').textContent        = t.title;
      document.getElementById('reminderText').placeholder = t.placeholderText;
      document.getElementById('addReminder').textContent  = t.addBtn;
      themeToggleBtn.textContent                          = t.themeBtn;

      // Повторы
      const repeatSelect = document.getElementById('reminderRepeat');
      repeatSelect.options[0].text = t.repeatNone;
      repeatSelect.options[1].text = t.every10m;
      repeatSelect.options[2].text = t.every1h;
      repeatSelect.options[3].text = t.every1d;
      repeatSelect.options[4].text = t.every1w;
      repeatSelect.options[5].text = t.every1M;

      // Категории
      const catSelect = document.getElementById('reminderCategory');
      catSelect.options[0].text = t.work;
      catSelect.options[1].text = t.personal;
      catSelect.options[2].text = t.study;
    }

    // =========================================================
    //      5) ФУНКЦИИ ДЛЯ НАПОМИНАНИЙ (TIMEOUT+NOTIFICATION)
    // =========================================================
    function saveReminders() {
      localStorage.setItem('reminders', JSON.stringify(reminders));
    }

    function cancelAllTimers() {
      reminderTimeouts.forEach(id => clearTimeout(id));
      reminderTimeouts = [];
    }

    function formatDate(d) {
      let y = d.getFullYear();
      let m = String(d.getMonth() + 1).padStart(2, '0');
      let day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function formatTime(d) {
      let hh = String(d.getHours()).padStart(2, '0');
      let mm = String(d.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
    }

    // Добавляем интервал (повтор)
    function addIntervalToDate(dateObj, repeatCode) {
      switch (repeatCode) {
        case '10m':
          dateObj.setMinutes(dateObj.getMinutes() + 10);
          break;
        case '1h':
          dateObj.setHours(dateObj.getHours() + 1);
          break;
        case '1d':
          dateObj.setDate(dateObj.getDate() + 1);
          break;
        case '1w':
          dateObj.setDate(dateObj.getDate() + 7);
          break;
        case '1M':
          dateObj.setMonth(dateObj.getMonth() + 1);
          break;
      }
    }

    // Показ десктоп-уведомления
    function showNotification(reminder) {
      if (!("Notification" in window)) {
        // alert как fallback
        alert(reminder.text);
        return;
      }
      if (Notification.permission === "granted") {
        new Notification("Напоминание", {
          body: reminder.text
        });
      } else {
        alert(reminder.text);
      }
    }

    // Запуск таймеров для всех напоминаний
    function resetAllTimers() {
      cancelAllTimers();

      const now = new Date();
      reminders.forEach(reminder => {
        if (!reminder.date && !reminder.time) return;
        const datePart = reminder.date || formatDate(now);
        const timePart = reminder.time || '00:00';
        const dateTimeString = datePart + 'T' + timePart;
        const reminderDateObj = new Date(dateTimeString);

        const diff = reminderDateObj - now;
        if (diff > 0) {
          let timerId = setTimeout(() => {
            showNotification(reminder);
            // Повтор?
            if (reminder.repeat && reminder.repeat !== 'none') {
              let newDT = new Date(reminderDateObj);
              addIntervalToDate(newDT, reminder.repeat);
              reminder.date = formatDate(newDT);
              reminder.time = formatTime(newDT);
              saveReminders();
              resetAllTimers();
            } else {
              // Удаляем (одноразовое)
              const idx = reminders.indexOf(reminder);
              if (idx !== -1) {
                reminders.splice(idx, 1);
                saveReminders();
              }
              renderCategories();
            }
          }, diff);
          reminderTimeouts.push(timerId);
        }
      });
    }

    // =========================================================
    //     6) ОТОБРАЖЕНИЕ КАТЕГОРИЙ (РАСКРЫВАЮЩИЕСЯ ПАНЕЛИ)
    // =========================================================
    function groupByCategory() {
      const groups = {
        "Работа":   [],
        "Личное":   [],
        "Учёба":    []
      };
      reminders.forEach(r => {
        // если новая неизвестная категория, можно было бы добавить
        if (!groups[r.category]) {
          groups[r.category] = []; 
        }
        groups[r.category].push(r);
      });
      return groups;
    }

    function createCategoryPanel(categoryName, arrReminders) {
      // Перевод названия категории
      let catLabel = categoryName;
      const t = translations[currentLang];
      if (t) {
        if (categoryName === 'Работа')  catLabel = t.work;
        if (categoryName === 'Личное')  catLabel = t.personal;
        if (categoryName === 'Учёба')   catLabel = t.study;
      }

      const panel = document.createElement('div');
      panel.className = 'category-panel';

      // Заголовок
      const header = document.createElement('div');
      header.className = 'category-header';

      const h2 = document.createElement('h2');
      h2.textContent = `${catLabel} (${arrReminders.length})`;

      const toggleSign = document.createElement('span');
      toggleSign.textContent = '▼';

      header.appendChild(h2);
      header.appendChild(toggleSign);

      const content = document.createElement('div');
      content.className = 'category-content';

      let isOpen = false;
      header.addEventListener('click', () => {
        isOpen = !isOpen;
        content.style.display = isOpen ? 'block' : 'none';
        toggleSign.textContent = isOpen ? '▲' : '▼';
      });

      // Список напоминаний
      arrReminders.forEach(reminder => {
        const item = document.createElement('div');
        item.className = 'reminder-item';

        let txt = reminder.text;
        let details = [];
        if (reminder.date) details.push(reminder.date);
        if (reminder.time) details.push(reminder.time);

        // повтор?
        if (reminder.repeat && reminder.repeat !== 'none') {
          switch (reminder.repeat) {
            case '10m': details.push(t ? t.every10m : 'каждые 10 минут'); break;
            case '1h':  details.push(t ? t.every1h : 'каждый час'); break;
            case '1d':  details.push(t ? t.every1d : 'каждый день'); break;
            case '1w':  details.push(t ? t.every1w : 'раз в неделю'); break;
            case '1M':  details.push(t ? t.every1M : 'каждый месяц'); break;
          }
        }

        if (details.length > 0) {
          txt += ' (' + details.join(', ') + ')';
        }

        const textSpan = document.createElement('span');
        textSpan.textContent = txt;

        // Кнопка "Удалить"
        const delBtn = document.createElement('button');
        delBtn.className = 'delete';
        delBtn.textContent = t ? t.deleteBtn : "Удалить";
        delBtn.addEventListener('click', () => {
          const idx = reminders.indexOf(reminder);
          if (idx !== -1) {
            reminders.splice(idx, 1);
            saveReminders();
            resetAllTimers();
            renderCategories();
          }
        });

        item.appendChild(textSpan);
        item.appendChild(delBtn);
        content.appendChild(item);
      });

      panel.appendChild(header);
      panel.appendChild(content);
      return panel;
    }

    function renderCategories() {
      const container = document.getElementById('categoriesContainer');
      container.innerHTML = '';

      const groups = groupByCategory();
      for (let catName in groups) {
        const arr = groups[catName];
        if (arr.length > 0) {
          const panel = createCategoryPanel(catName, arr);
          container.appendChild(panel);
        }
      }

      // После рендера категорий — применим цвета панелей заново
      applyCustomColors();
    }

    // =========================================================
    //        7) ДОБАВЛЕНИЕ НОВОГО НАПОМИНАНИЯ
    // =========================================================
    const reminderTextInput   = document.getElementById('reminderText');
    const reminderDateInput   = document.getElementById('reminderDate');
    const reminderTimeInput   = document.getElementById('reminderTime');
    const reminderCategorySel = document.getElementById('reminderCategory');
    const reminderRepeatSel   = document.getElementById('reminderRepeat');
    const addReminderBtn      = document.getElementById('addReminder');

    addReminderBtn.addEventListener('click', () => {
      const textValue   = reminderTextInput.value.trim();
      const dateValue   = reminderDateInput.value;
      const timeValue   = reminderTimeInput.value;
      const categoryVal = reminderCategorySel.value; 
      const repeatVal   = reminderRepeatSel.value;

      if (!textValue) return;

      reminders.push({
        text: textValue,
        date: dateValue,
        time: timeValue,
        category: categoryVal,
        repeat: repeatVal
      });

      saveReminders();
      resetAllTimers();
      renderCategories();

      // очистка формы
      reminderTextInput.value = '';
      reminderDateInput.value = '';
      reminderTimeInput.value = '';
      reminderCategorySel.value = 'Работа';
      reminderRepeatSel.value = 'none';
    });

    // =========================================================
    //         8) ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ
    // =========================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Запрашиваем разрешение на уведомления (один раз)
      if ("Notification" in window) {
        if (Notification.permission === "default") {
          Notification.requestPermission().then((result) => {
            console.log("Права на уведомления:", result);
          });
        }
      }
    });

    // 1) Применяем язык
    applyTranslations();

    // 2) Рисуем напоминания (панели по категориям)
    renderCategories();

    // 3) Запускаем таймеры
    resetAllTimers();

    // 4) Применяем (и загружаем) кастомные цвета
    initColorPickers();   // чтобы поля color были в актуальном состоянии
    applyCustomColors();  // сразу применяем
  </script>
</body>
</html>
